# Example ESPHome Configuration for Fingerprint Doorbell
# This is what the user puts in their ESPHome dashboard

substitutions:
  name: fingerprint-doorbell
  friendly_name: "Front Door Fingerprint"

# Include the fingerprint doorbell package
packages:
  fingerprint_doorbell: github://claudio-walser/esphome-fingerprint-doorbell/fingerprint-doorbell.yaml@main

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    platform: espressif32@6.4.0

esp32:
  board: esp32doit-devkit-v1
  framework:
    type: arduino

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name} Fallback"
    password: "12345678"

captive_portal:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# Enable OTA updates
ota:
  - platform: esphome
    password: !secret ota_password

# Enable logging
logger:

# Web server for REST API and diagnostics
# REST API available at /fingerprint/*
web_server:
  port: 80

# ============================================
# Fingerprint Doorbell Configuration
# ============================================

fingerprint_doorbell:
  id: fp_doorbell
  touch_pin: GPIO5       # Touch ring sensor
  doorbell_pin: GPIO19   # Doorbell output
  ignore_touch_ring: false  # Set to true if sensor is exposed to rain

# Sensors exposed to Home Assistant
sensor:
  - platform: fingerprint_doorbell
    match_id:
      name: "${friendly_name} Match ID"
    confidence:
      name: "${friendly_name} Confidence"

text_sensor:
  - platform: fingerprint_doorbell
    match_name:
      name: "${friendly_name} Match Name"
    enroll_status:
      name: "${friendly_name} Enrollment Status"
    last_action:
      name: "${friendly_name} Last Action"

binary_sensor:
  - platform: fingerprint_doorbell
    ring:
      name: "${friendly_name} Doorbell Ring"
    finger_detected:
      name: "${friendly_name} Finger Detected"

# ============================================
# Example Buttons (Optional)
# ============================================
# These buttons let you manage fingerprints from Home Assistant

button:
  # Enroll buttons - create one for each person
  - platform: template
    name: "Enroll John (ID 1)"
    icon: mdi:fingerprint
    on_press:
      - fingerprint_doorbell.enroll:
          finger_id: 1
          name: "John"

  - platform: template
    name: "Enroll Jane (ID 2)"
    icon: mdi:fingerprint
    on_press:
      - fingerprint_doorbell.enroll:
          finger_id: 2
          name: "Jane"

  # Cancel enrollment
  - platform: template
    name: "Cancel Enrollment"
    icon: mdi:cancel
    on_press:
      - fingerprint_doorbell.cancel_enroll

  # Delete buttons
  - platform: template
    name: "Delete ID 1"
    icon: mdi:delete
    on_press:
      - fingerprint_doorbell.delete:
          finger_id: 1

  - platform: template
    name: "Delete All Fingerprints"
    icon: mdi:delete-sweep
    on_press:
      - fingerprint_doorbell.delete_all

# ============================================
# Alternative: API Services (Legacy approach)
# ============================================
# If you prefer services over buttons, you can still use lambdas:
#
# api:
#   services:
#     - service: enroll_fingerprint
#       variables:
#         finger_id: int
#         finger_name: string
#       then:
#         - lambda: |-
#             id(fp_doorbell).start_enrollment(finger_id, finger_name);
