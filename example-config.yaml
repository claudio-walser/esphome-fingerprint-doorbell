# Example ESPHome Configuration for Fingerprint Doorbell
# This is what the user puts in their ESPHome dashboard

substitutions:
  name: fingerprint-doorbell
  friendly_name: "Front Door Fingerprint"

# Include the fingerprint doorbell package
packages:
  fingerprint_doorbell: github://claudio-walser/esphome-fingerprint-doorbell/fingerprint-doorbell.yaml@main

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  platformio_options:
    platform: espressif32@6.4.0

esp32:
  board: esp32doit-devkit-v1
  framework:
    type: arduino

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${friendly_name} Fallback"
    password: "12345678"

captive_portal:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
  # Fingerprint management services
  services:
    - service: enroll_fingerprint
      variables:
        finger_id: int
        finger_name: string
      then:
        - logger.log:
            format: "Enrolling fingerprint ID %d with name %s"
            args: [ 'finger_id', 'finger_name.c_str()' ]
        - lambda: |-
            id(fp_doorbell).enroll_fingerprint(finger_id, finger_name);
    
    - service: delete_fingerprint
      variables:
        finger_id: int
      then:
        - logger.log:
            format: "Deleting fingerprint ID %d"
            args: [ 'finger_id' ]
        - lambda: |-
            id(fp_doorbell).delete_fingerprint(finger_id);
    
    - service: delete_all_fingerprints
      then:
        - logger.log: "Deleting all fingerprints"
        - lambda: |-
            id(fp_doorbell).delete_all_fingerprints();
    
    - service: rename_fingerprint
      variables:
        finger_id: int
        new_name: string
      then:
        - logger.log:
            format: "Renaming fingerprint ID %d to %s"
            args: [ 'finger_id', 'new_name.c_str()' ]
        - lambda: |-
            id(fp_doorbell).rename_fingerprint(finger_id, new_name);
    
    - service: set_ignore_touch_ring
      variables:
        state: bool
      then:
        - logger.log:
            format: "Setting ignore touch ring to %d"
            args: [ 'state' ]
        - lambda: |-
            id(fp_doorbell).set_ignore_touch_ring_state(state);

# Enable OTA updates
ota:
  - platform: esphome
    password: !secret ota_password

# Optional: Web server for diagnostics
web_server:
  port: 80

# Optional: Override default pins if needed
# fingerprint_doorbell:
#   touch_pin: GPIO5      # Default
#   doorbell_pin: GPIO19  # Default
#   ignore_touch_ring: false  # Set to true if sensor is exposed to rain

# Optional: Customize sensor names
# sensor:
#   - platform: fingerprint_doorbell
#     match_id:
#       name: "Front Door Match ID"
#     confidence:
#       name: "Front Door Confidence"
