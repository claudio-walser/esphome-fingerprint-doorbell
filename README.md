# Fingerprint Doorbell - ESPHome Package

Transform your existing Fingerprint Doorbell project into a native ESPHome component with full Home Assistant integration!

## üéØ What This Package Does

This ESPHome package converts your Arduino-based Fingerprint Doorbell into a native ESPHome component, providing:

- ‚úÖ **Native Home Assistant Integration** - No MQTT needed, direct API integration
- ‚úÖ **Auto-Discovery** - Sensors automatically appear in Home Assistant
- ‚úÖ **Services** - Enroll, delete, and manage fingerprints from Home Assistant
- ‚úÖ **OTA Updates** - Update firmware wirelessly from ESPHome dashboard
- ‚úÖ **Web Interface** - Built-in web server for diagnostics
- ‚úÖ **Full Feature Parity** - All original features preserved

## üìã Prerequisites

- **ESPHome** installed (via Home Assistant add-on or standalone)
- **Home Assistant** (for full integration)
- **ESP32** board (esp32doit-devkit-v1 or compatible)
- **Grow R503** fingerprint sensor
- Basic knowledge of YAML configuration

## üöÄ Quick Start

### Method 1: Local Package (Recommended for Development)

1. **Copy the package to your ESPHome config directory:**
   ```bash
   cp -r esphome-package/components ~/.esphome/
   cp esphome-package/fingerprint-doorbell.yaml ~/.esphome/packages/
   ```

2. **Create your device configuration:**
   ```yaml
   # fingerprint-doorbell-front.yaml
   substitutions:
     name: fingerprint-doorbell-front
     friendly_name: "Front Door Fingerprint"

   packages:
     fingerprint_doorbell: !include packages/fingerprint-doorbell.yaml

   esphome:
     name: ${name}
     platform: ESP32
     board: esp32doit-devkit-v1

   wifi:
     ssid: !secret wifi_ssid
     password: !secret wifi_password

   api:
     encryption:
       key: !secret api_encryption_key

   ota:
     password: !secret ota_password
   ```

3. **Compile and upload:**
   ```bash
   esphome run fingerprint-doorbell-front.yaml
   ```

### Method 2: GitHub Package (Once Published)

```yaml
substitutions:
  name: fingerprint-doorbell

packages:
  fingerprint_doorbell: github://YOUR_USERNAME/fingerprint-doorbell-esphome/fingerprint-doorbell.yaml@main

esphome:
  name: ${name}
  platform: ESP32
  board: esp32doit-devkit-v1

# ... rest of config
```

## üîå Hardware Wiring

Same as the original project:

| ESP32 Pin | R503 Sensor Pin | Description |
|-----------|-----------------|-------------|
| GPIO16    | RX (Yellow)     | UART RX     |
| GPIO17    | TX (White)      | UART TX     |
| GPIO5     | Touch (Blue)    | Touch Ring  |
| 3.3V      | VCC (Red)       | Power       |
| GND       | GND (Black)     | Ground      |
| GPIO19    | -               | Doorbell Output (optional) |

**Important:** Ground the sensor housing to prevent ESD resets!

## üìä Exposed Entities

### Sensors
- **Fingerprint Match ID** (`sensor.fingerprint_match_id`)
  - ID of matched fingerprint (1-200)
  - `-1` when no match

- **Fingerprint Confidence** (`sensor.fingerprint_confidence`)
  - Match confidence score (1-400, higher is better)
  - `0` when no match

### Text Sensors
- **Fingerprint Match Name** (`text_sensor.fingerprint_match_name`)
  - Name of matched fingerprint
  - Empty when no match

### Binary Sensors
- **Doorbell Ring** (`binary_sensor.doorbell_ring`)
  - `on` when unknown finger detected (doorbell event)
  - Stays `on` for 1 second

- **Finger Detected** (`binary_sensor.finger_detected`)
  - `on` when any finger is on the sensor
  - `off` when no finger present

## üõ†Ô∏è Services & Actions

This component provides two ways to manage fingerprints:

1. **Home Assistant Actions** - Use in automations with `action:` blocks
2. **REST API** - Direct HTTP calls for standalone use

### Home Assistant Actions

All actions are available in your ESPHome device's YAML or Home Assistant automations:

#### `fingerprint_doorbell.enroll`
Enroll a new fingerprint.

**Parameters:**
- `finger_id` (int): ID 1-200
- `name` (string): Name for this fingerprint

**Example in automation:**
```yaml
automation:
  - alias: "Enroll New Finger"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: ENROLL_FINGER
    action:
      - action: fingerprint_doorbell.enroll
        data:
          finger_id: 1
          name: "John"
```

**Example in ESPHome button:**
```yaml
button:
  - platform: template
    name: "Enroll John"
    on_press:
      - fingerprint_doorbell.enroll:
          finger_id: 1
          name: "John"
```

**Process:**
1. Call the action
2. Place finger on sensor when LED flashes purple
3. Remove finger when LED turns solid purple
4. Repeat 5 times total
5. Enrollment complete!

#### `fingerprint_doorbell.cancel_enroll`
Cancel an in-progress enrollment.

**Example:**
```yaml
button:
  - platform: template
    name: "Cancel Enrollment"
    on_press:
      - fingerprint_doorbell.cancel_enroll
```

#### `fingerprint_doorbell.delete`
Delete a single fingerprint.

**Parameters:**
- `finger_id` (int): ID to delete

**Example:**
```yaml
button:
  - platform: template
    name: "Delete Finger 1"
    on_press:
      - fingerprint_doorbell.delete:
          finger_id: 1
```

#### `fingerprint_doorbell.delete_all`
Delete all enrolled fingerprints.

**Example:**
```yaml
button:
  - platform: template
    name: "Delete All"
    on_press:
      - fingerprint_doorbell.delete_all
```

#### `fingerprint_doorbell.rename`
Rename an existing fingerprint.

**Parameters:**
- `finger_id` (int): ID to rename
- `name` (string): New name

**Example:**
```yaml
button:
  - platform: template
    name: "Rename Finger 1"
    on_press:
      - fingerprint_doorbell.rename:
          finger_id: 1
          name: "John Smith"
```

---

### REST API Endpoints

The component exposes a REST API at `/fingerprint/*` for standalone device management without Home Assistant.

**Base URL:** `http://<device-ip>/fingerprint/`

#### `GET /fingerprint/list`
Get list of all enrolled fingerprints.

**Example:**
```bash
curl http://192.168.1.100/fingerprint/list
```

**Response:**
```json
[
  {"id": 1, "name": "John"},
  {"id": 2, "name": "Jane"}
]
```

#### `GET /fingerprint/status`
Get current sensor status.

**Example:**
```bash
curl http://192.168.1.100/fingerprint/status
```

**Response:**
```json
{
  "connected": true,
  "enrolling": false,
  "count": 2
}
```

#### `POST /fingerprint/enroll?id=X&name=Y`
Start fingerprint enrollment.

**Parameters:**
- `id` (int): Fingerprint ID (1-200)
- `name` (string): Name for fingerprint

**Example:**
```bash
curl -X POST "http://192.168.1.100/fingerprint/enroll?id=3&name=Alice"
```

**Response:**
```json
{"status": "enrollment_started", "id": 3, "name": "Alice"}
```

After calling, place finger on sensor 5 times (LED guides you).

#### `POST /fingerprint/cancel`
Cancel in-progress enrollment.

**Example:**
```bash
curl -X POST http://192.168.1.100/fingerprint/cancel
```

**Response:**
```json
{"status": "cancelled"}
```

#### `POST /fingerprint/delete?id=X`
Delete a fingerprint.

**Parameters:**
- `id` (int): Fingerprint ID to delete

**Example:**
```bash
curl -X POST "http://192.168.1.100/fingerprint/delete?id=1"
```

**Response:**
```json
{"status": "deleted", "id": 1}
```

#### `POST /fingerprint/delete_all`
Delete all fingerprints.

**Example:**
```bash
curl -X POST http://192.168.1.100/fingerprint/delete_all
```

**Response:**
```json
{"status": "all_deleted"}
```

#### `POST /fingerprint/rename?id=X&name=Y`
Rename a fingerprint.

**Parameters:**
- `id` (int): Fingerprint ID
- `name` (string): New name

**Example:**
```bash
curl -X POST "http://192.168.1.100/fingerprint/rename?id=1&name=John%20Smith"
```

**Response:**
```json
{"status": "renamed", "id": 1, "name": "John Smith"}
```

#### REST API Authentication

The REST API can be protected with a Bearer token. Configure `api_token` in your component:

```yaml
fingerprint_doorbell:
  id: fp_doorbell
  api_token: "your-secret-token-here"  # Or use ${api_encryption_key}
```

Then include the token in your requests:

```bash
# With authentication
curl -H "Authorization: Bearer your-secret-token-here" \
  http://192.168.1.100/fingerprint/list

# POST requests also need -d ""
curl -X POST -d "" \
  -H "Authorization: Bearer your-secret-token-here" \
  "http://192.168.1.100/fingerprint/enroll?id=1&name=John"
```

**Without a token configured:** API is open (for development/testing)
**With a token configured:** All endpoints require `Authorization: Bearer <token>` header

**Response when unauthorized:**
```json
{"error": "Unauthorized"}
```

---

### Additional Text Sensors

To monitor enrollment progress, add these text sensors:

```yaml
text_sensor:
  - platform: fingerprint_doorbell
    enroll_status:
      name: "Enrollment Status"
    last_action:
      name: "Last Action"
```

**Enrollment Status Values:**
- `Place finger (1/5)` through `Place finger (5/5)`
- `Remove finger`
- `Creating model...`
- `Storing...`
- `Success!`
- `Error: ...` (various error messages)
- `Timeout`
- `Cancelled`

## üé® LED Ring Indicators

| Color | Pattern | Meaning |
|-------|---------|---------|
| Blue | Breathing | Ready (touch ring enabled) |
| Blue | Solid | Ready (touch ring disabled) |
| Red | Flashing | Finger detected, scanning |
| Purple | Flashing | Enrollment mode, waiting for finger |
| Purple | Solid | Match found / enrollment pass complete |
| Red | Solid | Error state |

## üè° Home Assistant Integration Examples

### Auto-Unlock Door on Match
```yaml
automation:
  - alias: "Front Door Auto Unlock"
    trigger:
      - platform: state
        entity_id: sensor.fingerprint_match_id
    condition:
      - condition: numeric_state
        entity_id: sensor.fingerprint_match_id
        above: 0
      - condition: numeric_state
        entity_id: sensor.fingerprint_confidence
        above: 150
    action:
      - service: lock.unlock
        target:
          entity_id: lock.front_door
      - service: notify.mobile_app
        data:
          message: "Door unlocked for {{ states('text_sensor.fingerprint_match_name') }}"
```

### Doorbell Notification
```yaml
automation:
  - alias: "Doorbell Ring Notification"
    trigger:
      - platform: state
        entity_id: binary_sensor.doorbell_ring
        to: "on"
    action:
      - service: notify.mobile_app
        data:
          message: "Someone is at the front door"
          title: "Doorbell Ring"
```

### Rain Protection
```yaml
automation:
  - alias: "Fingerprint Rain Protection"
    trigger:
      - platform: state
        entity_id: binary_sensor.rain_sensor
    action:
      - service: esphome.fingerprint_doorbell_front_set_ignore_touch_ring
        data:
          state: "{{ is_state('binary_sensor.rain_sensor', 'on') }}"
```

## ‚öôÔ∏è Configuration Options

### Override Default Pins
```yaml
fingerprint_doorbell:
  touch_pin: GPIO5       # Default
  doorbell_pin: GPIO19   # Default
  ignore_touch_ring: false  # Set true for rain-exposed sensors
```

### Customize UART Pins
```yaml
fingerprint_doorbell:
  sensor_rx_pin: 16  # ESP32 RX <- Sensor TX (default GPIO16)
  sensor_tx_pin: 17  # ESP32 TX -> Sensor RX (default GPIO17)
```

### Customize Sensor Names
```yaml
sensor:
  - platform: fingerprint_doorbell
    match_id:
      name: "Custom Match ID Name"
    confidence:
      name: "Custom Confidence Name"
```

## üîß Troubleshooting

### Sensor Not Found
- Check wiring (RX/TX may need to be swapped - sensor TX goes to ESP32 RX)
- Verify 3.3V power supply
- Ensure sensor housing is grounded
- Check ESPHome logs: `esphome logs fingerprint-doorbell-front.yaml`

### False Doorbell Rings in Rain
- Set `ignore_touch_ring: true` in config, OR
- Use Home Assistant automation to dynamically enable rain protection

### Enrollment Fails
- Ensure finger is clean and dry
- Place finger consistently in the same position
- Don't press too hard or too soft
- Wait for LED to turn solid purple before removing finger

### Compilation Errors
- Ensure you have the Adafruit Fingerprint library:
  ```yaml
  esphome:
    libraries:
      - "adafruit/Adafruit Fingerprint Sensor Library@^2.1.0"
  ```

## üì¶ What's Included

```
esphome-package/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ fingerprint_doorbell/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py              # Component registration
‚îÇ       ‚îú‚îÄ‚îÄ fingerprint_doorbell.h   # C++ header
‚îÇ       ‚îú‚îÄ‚îÄ fingerprint_doorbell.cpp # Core implementation
‚îÇ       ‚îú‚îÄ‚îÄ sensor.py                # Sensor platform
‚îÇ       ‚îú‚îÄ‚îÄ text_sensor.py           # Text sensor platform
‚îÇ       ‚îî‚îÄ‚îÄ binary_sensor.py         # Binary sensor platform
‚îú‚îÄ‚îÄ fingerprint-doorbell.yaml        # Main package config
‚îú‚îÄ‚îÄ example-config.yaml              # User config example
‚îú‚îÄ‚îÄ example-secrets.yaml             # Secrets template
‚îî‚îÄ‚îÄ home-assistant-examples.yaml     # HA automation examples
```

## üÜö Comparison: Original vs ESPHome

| Feature | Original (PlatformIO) | ESPHome Package |
|---------|----------------------|-----------------|
| Home Assistant Integration | MQTT | Native API |
| Configuration | Web UI | YAML + HA Services |
| Updates | Manual/Web OTA | ESPHome Dashboard |
| Fingerprint Management | Web UI | HA Services |
| Logging | Web UI | ESPHome Logs |
| Sensor Data | MQTT Topics | HA Entities |
| Setup Complexity | Medium | Easy |
| Customization | C++ Code | YAML Config |

## üîÑ Migration from Original

If you're migrating from the original PlatformIO project:

1. **Fingerprints are NOT preserved** - You'll need to re-enroll
2. **Settings reset** - Reconfigure via ESPHome YAML
3. **MQTT not needed** - Uses Home Assistant API
4. **Web UI replaced** - Use Home Assistant UI + Services

## üìö Additional Resources

- [ESPHome Documentation](https://esphome.io)
- [Original Project README](../README.md)
- [Grow R503 Datasheet](https://cdn.shopify.com/s/files/1/0551/3656/5159/files/R503_fingerprint_module_user_manual.pdf)
- [Home Assistant ESPHome Integration](https://www.home-assistant.io/integrations/esphome/)

## ü§ù Contributing

Found a bug or have a feature request? Please open an issue or submit a pull request!

## üìÑ License

Same license as the original FingerprintDoorbell project.

## üôè Credits

- Original FingerprintDoorbell by frickelzeugs
- ESPHome package conversion by [Your Name]
- Inspired by Everything Smart Home's Everything Presence One

---

**Note:** This is an ESPHome reimplementation. For the original PlatformIO version, see the main project README.
